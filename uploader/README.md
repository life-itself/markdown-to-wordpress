ðŸš© For most of this to work you need `next.lifeitself.org` subdirectory with the next.lifeitself.org markdown repo contents there.

## Usage

Set up the simple Node script in this repo to convert Markdown and upload to WordPress:

1.  **Install dependencies**:
    ```sh
    npm install
    ```
2.  **Configure Environment**: Copy `.env.sample` to `.env` and set the following variables:
    *   `WP_BASE_URL`: The base URL of your WordPress site (e.g., `https://example.com`).
    *   `WP_USERNAME`: Your WordPress username.
    *   `WP_APP_PASSWORD`: A WordPress [application password](https://make.wordpress.org/core/2020/11/05/application-passwords-integration-guide/).

3.  **Create Markdown Files**: Write your posts in Markdown with YAML front matter. The `title` field is required.

    *Example (`my-post.md`):*
    ```markdown
    ---
    title: My Awesome Post
    slug: my-awesome-post
    status: draft
    tags: [tech, blogging]
    excerpt: A brief summary of the post.
    ---

    Your post content here, written in GitHub-Flavored Markdown.
    ```

    Date handling: include a `date` to set the publish time, or `created` if you only have that field; if both are missing the uploader assigns today's date during upload.

4.  **Run the Uploader**: Execute the script from your terminal, passing one or more paths to your Markdown files or directories containing them.

    *   **Upload a single file**:
        ```sh
        node upload.js path/to/my-post.md
        ```

    *   **Upload multiple files**:
        ```sh
        node upload.js file1.md file2.md
        ```

    *   **Upload all Markdown files in a directory (and its subdirectories)**:
        ```sh
        node upload.js path/to/my/posts/
        ```

    *   **Upload a combination of files and directories**:
        ```sh
        node upload.js file1.md my-blog/
        ```

    On success, the script will log the URL of each uploaded post.

`upload.js` can also set the WordPress author using a local mapping file: pass `--authors path/to/authors.json` (defaults to `authors.json` in this directory). The mapping should map local author names to objects with a `wordpress_id`; any authors not found in the map are skipped with a warning.

5.  **(Optional) Run Tests**:
    To verify the Markdown processing module, run the tests:
    ```sh
    npm test
    ```

### Image rewriting

`upload.js` rewrites local image/PDF references to their WordPress URLs using `uploadMediaMap.json` (generated by `uploadMedia.js`). It also sets the post's featured image: front matter `image` wins, otherwise the first image in the body. By default URLs are made relative (e.g. `/wp-content/uploads/...`); pass `--absolute-media-urls` to keep full URLs, or `-m custom-map.json` to point at a different mapping file.

### Upload Media Files

Use `uploadMedia.js` to push local images to WordPress before wiring their URLs into Markdown posts:

1.  **Prepare media**: Pass file and/or directory paths pointing at supported assets (`.png`, `.jpg`, `.jpeg`, `.gif`, `.svg`, `.webp`, `.bmp`, `.tif`, `.tiff`, `.avif`, `.heic`, `.heif`, `.pdf`). Directories are scanned recursively.
2.  **Run the media uploader**:
    ```sh
    node uploadMedia.js path/to/image.png another/folder/
    ```
    *Use `-m custom-map.json` to override the mapping file location (`uploadMediaMap.json` by default). Use `-c 5` (default) to set parallel uploads.*
3.  **Idempotent uploads**: The script records each upload in `uploadMediaMap.json` (filename â†’ hash â†’ destination URL) and preserves the original absolute path for reference. Each filename is assumed to be unique in the project; identical hashes are skipped while changed files are re-uploaded and the mapping is updated with the latest metadata as uploads succeed.
4.  **Progress + metadata**: Live progress shows total processed/percent, active uploads, and the latest result. Each media item receives the original local path and file hash inside `meta[original_local_path]` / `meta[original_local_hash]`, letting WordPress keep track of the source asset.

`uploadMediaMap.json` is committed to this repo so later steps (e.g., rewriting Markdown image references) can reference already-uploaded assets.

### Upload Team Members

Use `uploadPerson.js` to create/update entries in the WordPress `team` post type from the markdown files in `next.lifeitself.org/people`.

1.  **List existing team entries**:
    ```sh
    node uploadPerson.js --list
    ```
2.  **Upload one or more people** (files or directories):
    ```sh
    node uploadPerson.js next.lifeitself.org/people/alexia.md
    node uploadPerson.js next.lifeitself.org/people/
    ```
    *Slug is taken from `id`/`slug` in front matter, otherwise from the filename; name is required. Status defaults to `publish`.*
3.  **Avoid duplicates**: by default the script exits if a team member with the same slug/name already exists. Pass `--override` (or `-o`) to update the existing entry instead of failing.

`uploadPerson.js` also sets the avatar/featured image for a person when `avatar` is present in front matter by resolving it through `uploadMediaMap.json` (default location: current directory). Use `-m custom-map.json` to point to a different mapping file; the mapping file must exist.

If you provide an authors mapping (`-a path/to/authors.json` or the default `research/authors.json` when present) the script will skip entries already carrying a `wordpress_id` unless `--override` is set, and will update the mapping with any newly created/updated IDs.
